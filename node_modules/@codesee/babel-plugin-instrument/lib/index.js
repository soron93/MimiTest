"use strict";var _helperPluginUtils=require("@babel/helper-plugin-utils"),_core=require("@babel/core"),_traverse=_interopRequireDefault(require("@babel/traverse")),_fs=_interopRequireDefault(require("fs")),_jestUtil=require("jest-util"),_objectPath=require("object-path"),_constants=require("./constants"),_utils=require("./utils"),_trackingConfig=_interopRequireDefault(require("./tracking-config")),_ensureBlockStatements=require("./visitors/ensure-block-statements"),_tracing=require("./visitors/tracing"),_dataTracking=require("./visitors/data-tracking"),_inlineDataTracking=_interopRequireDefault(require("./visitors/inline-data-tracking")),_ensureClassConstructors=require("./visitors/ensure-class-constructors"),_ensureSimpleComputedMemberExpressions=require("./visitors/ensure-simple-computed-member-expressions"),_functionInputTracking=_interopRequireDefault(require("./visitors/function-input-tracking")),_checkSourceType=_interopRequireDefault(require("./visitors/check-source-type")),_finalCleanup=require("./visitors/final-cleanup"),_catchErrors=_interopRequireDefault(require("./visitors/catch-errors")),_dynamicSacreds=_interopRequireDefault(require("./visitors/dynamic-sacreds")),_jestSetupTeardown=_interopRequireDefault(require("./visitors/jest/jest-setup-teardown")),_pkgUp=_interopRequireDefault(require("pkg-up")),_perf_hooks=require("perf_hooks");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_unsupportedIterableToArray(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(a,b){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(a)))return;var c=[],d=!0,e=!1,f=void 0;try{for(var g=a[Symbol.iterator](),h;!(d=(h=g.next()).done);d=!0){c.push(h.value);if(b&&c.length===b)break}}catch(a){e=!0;f=a}finally{try{if(!d&&null!=g["return"])g["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_unsupportedIterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(a);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _iterableToArray(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a))return _arrayLikeToArray(a)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}var _require=require("@babel/plugin-transform-typescript"),typescriptPlugin=_require["default"],TRACKER_MODULE_NAME="@codesee/tracker",getTrimmedFilename=function(a){var b=(0,_objectPath.get)(a,"file.opts.filename","root"),c=(0,_objectPath.get)(a,"file.opts.root","");return b.replace(c,"")},rootFileName=null,rootSource=null,extractCommentsFromNode=function(a){return[].concat(_toConsumableArray(a.leadingComments?a.leadingComments:[]),_toConsumableArray(a.innerComments?a.innerComments:[]),_toConsumableArray(a.trailingComments?a.trailingComments:[]))},getAllCommentsFromNode=function(a){var b=extractCommentsFromNode(a);return a.body?a.body.reduce(function(a,b){var c=extractCommentsFromNode(b);return[].concat(_toConsumableArray(a),_toConsumableArray(c))},b):b},accumulatedTime={overall:0,typescript:0,inline:0,unified:0,functionNames:0,traceLine:0,lhs:0,funcInputs:0,traceStack:0,checkSource:0,cleanup:0,catchErrors:0};module.exports=(0,_helperPluginUtils.declare)(function(a,b){a.assertVersion(7);b.includeLibs||(b.includeLibs=[]);b.frameworks||(b.frameworks=[]);b.configFile||(b.configFile="codesee.config.js");if(b.verbose===void 0){b.verbose=!0}var c=b.frameworks.includes("ember"),d=(0,_tracing.annotateFunctionNameVisitorFactory)(a.version),e=(0,_inlineDataTracking["default"])(b.verbose),f=(0,_functionInputTracking["default"])(a.version),g=(0,_tracing.traceStackFrameVisitorFactory)(a.version),h=_traverse["default"].visitors.merge([_dynamicSacreds["default"],_ensureBlockStatements.ensureBlockStatementsVisitor,_ensureClassConstructors.ensureClassConstructorsVisitor,_ensureSimpleComputedMemberExpressions.ensureSimpleComputedMemberExpressions]),i;if(b.tsExtensions){i=new RegExp(b.tsExtensions)}else{i=/.tsx?$/}var j,k,l,m,n,o=function(){var a=_perf_hooks.performance.now();accumulatedTime.overall+=a-n};return{name:"@codesee/babel-plugin-instrument",pre:function pre(a){n=_perf_hooks.performance.now();var c=(0,_objectPath.get)(a,"opts.root",""),d=c+"/"+b.configFile,e=c+"/src/"+b.configFile;if(_fs["default"].existsSync(d)){k=d}else if(_fs["default"].existsSync(e)){k=e}var f=_pkgUp["default"].sync({cwd:c});if(f){var g=require(f);l=g.name}},post:o,visitor:{Program:{enter:function enter(n,o){var p=n.hub.file.opts.filename||"";if(p.match(/node_modules/)||p.match(/@codesee/)){console.warn("CodeSee is skipping this file, even though Babel is configured to transform it:\n"+p);o.skip=!0;return}if((0,_utils.hasCodeSeeInstrumentation)(n)){o.skip=!0;return}if(-1===b.includeLibs.indexOf("gatsby")&&p.match(/\/\.cache\//)){o.skip=!0;return}var q=getAllCommentsFromNode(n.node);if(q.some(function(a){return a.value.includes("@Codesee-ignore-file")})){o.skip=!0;return}m=getTrimmedFilename(o)||"root";rootSource=n.hub.file.code.split("\n");rootFileName=l?"".concat(l,"|").concat(m):m;j=new _trackingConfig["default"];if(o.opts.onlyTrack)j.set(o.opts.onlyTrack.split(","));if(j.shouldTrack(_constants.codeSeeSource)){var r=[_core.types.objectExpression([_core.types.objectProperty(_core.types.stringLiteral(rootFileName),_core.types.arrayExpression(rootSource.map(function(a){return _core.types.stringLiteral(a)})))])],s=(0,_utils.codeSeeCall)(_core.types,"source",r);n.unshiftContainer("body",_core.types.expressionStatement(s))}o.rootFileName=rootFileName;o.trackingConfig=j;o.version=a.version;var t=_perf_hooks.performance.now(),u=a.version.split(/[-\.]/),v=_slicedToArray(u,2),w=v[0],x=v[1];if(7<w||7==w&&2<=x){n.traverse(_dataTracking.enumVisitor,o);if(i.test(m)||!m.includes(".")){var G=typescriptPlugin(a).visitor;(0,_traverse["default"])(n.hub.file.ast,G,n.hub.file.scope,o)}}accumulatedTime.typescript+=_perf_hooks.performance.now()-t;var y=_perf_hooks.performance.now();n.traverse(h);accumulatedTime.unified+=_perf_hooks.performance.now()-y;var z=_perf_hooks.performance.now();(0,_traverse["default"])(n.hub.file.ast,d,n.hub.file.scope,o);accumulatedTime.functionNames+=_perf_hooks.performance.now()-z;var A=_perf_hooks.performance.now();n.traverse(_tracing.traceLineVisitor,o);accumulatedTime.traceLine+=_perf_hooks.performance.now()-A;if(b.verbose){var H=_perf_hooks.performance.now();n.traverse(_dataTracking.trackerVisitor,o);accumulatedTime.lhs+=_perf_hooks.performance.now()-H}var B=_perf_hooks.performance.now();n.traverse(e,o);var C=_perf_hooks.performance.now();accumulatedTime.inline+=C-B;if(b.verbose){var I=_perf_hooks.performance.now();n.traverse(f,o);accumulatedTime.funcInputs+=_perf_hooks.performance.now()-I}var D=_perf_hooks.performance.now();(0,_traverse["default"])(n.hub.file.ast,g,n.hub.file.scope,o);accumulatedTime.traceStack+=_perf_hooks.performance.now()-D;var E=_perf_hooks.performance.now(),F={setsModuleExports:!1,usesES6ImportExport:!1};n.traverse(_checkSourceType["default"],F);accumulatedTime.checkSource+=_perf_hooks.performance.now()-E;if(!c&&j.shouldTrack("codeSeeImports")){var J=TRACKER_MODULE_NAME+(b.hosted?"/build/codesee.node.hosted.js":"/build/codesee.node.js");if(F.setsModuleExports&&!F.usesES6ImportExport){o.file.path.node.sourceType="script";if(k){(0,_utils.addRequireStatement)(_core.types,n,k)}(0,_utils.addRequireStatement)(_core.types,n,J)}else{if(k){(0,_utils.addImportOrRequireStatement)(n,k)}(0,_utils.addImportOrRequireStatement)(n,J)}}if(b.jestConfig){if(b.jestConfig.testMatch.length){if((0,_jestUtil.globsToMatcher)(b.jestConfig.testMatch)((0,_jestUtil.replacePathSepForGlob)(p))){(0,_traverse["default"])(n.hub.file.ast,_jestSetupTeardown["default"],n.hub.file.scope,{filename:m})}}}},exit:function exit(a,b){if(b.skip){return}var c=_perf_hooks.performance.now();a.traverse(_finalCleanup.finalCleanupVisitor);accumulatedTime.cleanup+=_perf_hooks.performance.now()-c;var d=_perf_hooks.performance.now();a.traverse(_catchErrors["default"]);accumulatedTime.catchErrors+=_perf_hooks.performance.now()-d}}},manipulateOptions:function manipulateOptions(a,b){b.plugins.push("jsx")}}});function anyTypescript(a,b){var c={},d=b.version.split(/[-\.]/),e=_slicedToArray(d,1),f=e[0];if(7<=f){a.traverse({"TSType|TSQualifiedName|TSTypeElement|TSAsExpression|TSDeclareFunction|TSDeclareMethod|TSEnumDeclaration|TSEnumMember|TSExportAssignment|TSExternalModuleReference|TSImportEqualsDeclaration|TSInterfaceBody|TSInterfaceDeclaration|TSModuleBlock|TSModuleDeclaration|TSNamespaceExportDeclaration|TSNonNullExpression|TSParameterProperty|TSTypeAliasDeclaration|TSTypeAnnotation|TSTypeAssertion|TSTypeParameter|TSTypeParameterDeclaration|TypeParameterInstantiation":{enter:function enter(a,b){b.present=!0;a.stop()}}},c);if(c.present){return!0}}return!1}