"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.insertLoopBodyBeginAndEnd=exports.wrapLikeIdentifier=exports.wrapCallLikeExpression=exports.wrapAndReplace=exports.wrap=void 0;var _uid=require("../../uid"),_constants=require("../../constants"),_utils=require("../../utils"),_core=require("@babel/core"),wrap=function(a,b){var c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{},d=c.force,e=c.additionalParams,f=c.loc;if(a.node.codesee&&!d)return;if(a.node.tracked&&!d)return;if(!a.node.loc){return}var g=(0,_utils.findStackFrameIdIdentifier)(a);if(g===void 0){return}var h=[a.node,g,_core.types.stringLiteral(f||(0,_utils.getLocString)(a.node.loc))];if(a.isIdentifier()){h.push(_core.types.stringLiteral((0,_uid.determineIdentifierUID)(a.node.name,a)))}if(e){e.forEach(function(a){h.push(a)})}var i=(0,_utils.codeSeeCall)(_core.types,b,h);i.loc=a.node.loc;return i};exports.wrap=wrap;var wrapAndReplace=function(a,b,c){var d=3<arguments.length&&arguments[3]!==void 0?arguments[3]:{},e=d.force,f=d.additionalParams,g=d.loc,h=wrap(a,b,{force:e,additionalParams:f,loc:g});if(h===void 0){return}a.node.tracked=!0;if(c.shouldTrack(_constants.codeSeeInlineTracking)){var k=a.node;a.replaceWith(h);if(_core.types.isIdentifier(k)){var i=a.get("arguments.0"),j=a.scope.getBinding(k.name);if(j){var l=j.referencePaths.findIndex(function(b){return b===a});if(0<=l){j.referencePaths[l]=i}}}}};exports.wrapAndReplace=wrapAndReplace;var wrapCallLikeExpression=function(a,b){var c=nameFromCallLikeExpression(a.node),d=wrap(a,"callLikeExpr",{additionalParams:[c]});if(!d){return}var e=(0,_utils.findStackFrameIdIdentifier)(a);if(e===void 0){return}var f=a.node.loc;if(!f){return}var g=[e,_core.types.stringLiteral((0,_utils.getLocString)(f))],h=(0,_utils.codeSeeCall)(_core.types,"aboutToCall",g);h.loc=f;var i=_core.types.sequenceExpression([h,d]);i.codesee=!0;i.loc=f;if(b.shouldTrack(_constants.codeSeeInlineTracking)){a.replaceWith(i)}};exports.wrapCallLikeExpression=wrapCallLikeExpression;var nameFromCallLikeExpression=function(a){switch(a.type){case"CallExpression":if(_core.types.isIdentifier(a.callee)){return _core.types.stringLiteral(a.callee.name)}else if(_core.types.isMemberExpression(a.callee)){var b=a.callee.property;if(_core.types.isIdentifier(b)){return _core.types.stringLiteral(b.name)}else if(_core.types.isStringLiteral(b)){return _core.types.stringLiteral(b.value)}}break;case"NewExpression":if(_core.types.isIdentifier(a.callee)){return _core.types.stringLiteral("new "+a.callee.name)}break;}return _core.types.identifier("undefined")},wrapLikeIdentifier=function(a,b,c){var d="read",e=a.parentPath;if(e.isIfStatement()||e.isSwitchStatement()&&"discriminant"===a.key||e.isReturnStatement()||e.isUpdateExpression()){return}if(e.isMemberExpression()&&"object"===a.key){if(b.statements[0]){b.statements[0].possibleMutations+=1}if("callee"===e.key&&e.parentPath.isCallExpression()){return}else{d="getProp"}}else if((e.isCallExpression()||e.isNewExpression())&&"arguments"===a.listKey){if(b.statements[0]){b.statements[0].possibleMutations+=1}d="funcArg"}wrapAndReplace(a,d,c)};exports.wrapLikeIdentifier=wrapLikeIdentifier;var insertLoopBodyBeginAndEnd=function(a,b,c){var d=(0,_utils.findStackFrameIdIdentifier)(a);if(d===void 0){return}var e=[d,_core.types.stringLiteral((0,_utils.getLocString)(b))],f=(0,_utils.codeSeeCall)(_core.types,"loopBodyBegin",e),g=(0,_utils.codeSeeCall)(_core.types,"loopBodyEnd",e),h=a.get("body").get("body"),i=h[0],j=h[Math.max(0,h.length-1)];if(c.shouldTrack(_constants.codeSeeInlineTracking)){if(i){i.insertBefore(_core.types.expressionStatement(f));j.insertAfter(_core.types.expressionStatement(g))}else{a.node.body.body=[f,g]}}};exports.insertLoopBodyBeginAndEnd=insertLoopBodyBeginAndEnd;