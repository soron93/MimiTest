"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports["default"]=rhsDataTrackingVisitorFactory;var _constants=require("../constants"),_insert=require("./inline-data-tracking/insert"),_utils=require("../utils"),_triviallyBoolean=_interopRequireDefault(require("./trivially-boolean")),_core=require("@babel/core");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);if(b)d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable});c.push.apply(c,d)}return c}function _objectSpread(a){for(var b=1,c;b<arguments.length;b++){c=null!=arguments[b]?arguments[b]:{};if(b%2){ownKeys(Object(c),!0).forEach(function(b){_defineProperty(a,b,c[b])})}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(a,Object.getOwnPropertyDescriptors(c))}else{ownKeys(Object(c)).forEach(function(b){Object.defineProperty(a,b,Object.getOwnPropertyDescriptor(c,b))})}}return a}function _defineProperty(a,b,c){if(b in a){Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0})}else{a[b]=c}return a}function _typeof(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}function rhsDataTrackingVisitorFactory(a){var b={Statement:{enter:function enter(a,b){if("object"!==_typeof(b.statements)){b.statements=[]}b.statements.unshift({path:a,possibleMutations:0})},exit:function exit(a,b){var c=b.statements.shift(),d=c.possibleMutations;if(a.isReturnStatement()||a.isExpressionStatement()&&a.get("expression").isYieldExpression()){return}if(d){var e=(0,_utils.codeSeeCall)(_core.types,"checkForMutations",[]);if(b.trackingConfig.shouldTrack(_constants.codeSeeInlineTracking)){var f=a.get("body");if(null!==f&&void 0!==f&&f.isBlockStatement()){var g=f.get("body")[0];if(g){g.insertBefore(_core.types.expressionStatement(e))}else{f.node.body=[_core.types.expressionStatement(e)]}}else{a.insertAfter(_core.types.expressionStatement(e))}}}}},Flow:function Flow(a){a.skip()},ImportDeclaration:function ImportDeclaration(a){a.skip()},ExportSpecifier:function ExportSpecifier(a){a.skip()},ExportNamespaceSpecifier:function ExportNamespaceSpecifier(a){a.skip()},"ReturnStatement|YieldExpression":{exit:function exit(a,b){if(a.node.argument&&!a.node.argument.codeseeId){(0,_insert.wrapAndReplace)(a.get("argument"),"returnVal",b.trackingConfig,{force:!0});(0,_utils.liftAndReplace)(_core.types,a.get("argument"),"returnValue")}}},Expression:{enter:function enter(a){if(a.node.codesee){a.skip()}}},CallExpression:{enter:function enter(a,b){if(_core.types.isIdentifier(a.node.callee)){a.skipKey("callee")}if((0,_utils.isSacredCallExpression)(a)){(0,_insert.wrapCallLikeExpression)(a,b.trackingConfig);a.skip()}},exit:function exit(a,b){if(a.node.codesee)return;if(!a.get("callee").isSuper()){(0,_insert.wrapCallLikeExpression)(a,b.trackingConfig)}}},AwaitExpression:{exit:function exit(a){if(a.node.tracked)return;var b=(0,_utils.getLocString)(a.node.loc),c=(0,_utils.findStackFrameIdIdentifier)(a);if(c===void 0){return}var d=(0,_utils.generateTempIdentifier)(a.scope,"awaitResult"),e=_core.types.variableDeclaration("let",[_core.types.variableDeclarator(d)]);e.codesee=!0;var f=(0,_insert.wrap)(a.get("argument"),"aboutToAwait",{force:!0,loc:b}),g=_core.types.awaitExpression(f);g.loc=a.node.loc;g.tracked=!0;var h=_core.types.sequenceExpression([_core.types.assignmentExpression("=",d,g),_core.types.assignmentExpression("=",c,(0,_utils.codeSeeCall)(_core.types,"backFromAwait",[d,c,_core.types.stringLiteral(b)])),d]);h.codesee=!0;h.loc=a.node.loc;a.getStatementParent().insertBefore(e);a.replaceWith(h)}},OptionalCallExpression:{enter:function enter(a){a.skipKey("callee")},exit:function exit(a,b){(0,_insert.wrapCallLikeExpression)(a,b.trackingConfig)}},AssignmentExpression:function AssignmentExpression(a){a.skipKey("left")},VariableDeclaration:function VariableDeclaration(){},VariableDeclarator:function VariableDeclarator(a){a.skipKey("id")},Decorator:function Decorator(a){a.skip()},Function:function Function(a){a.skipKey("params")},FunctionDeclaration:function FunctionDeclaration(a){a.skipKey("id")},"ClassDeclaration|ClassExpression":function ClassDeclarationClassExpression(a){a.skipKey("id")},NewExpression:{enter:function enter(a){a.skipKey("callee")},exit:function exit(a,b){(0,_insert.wrapCallLikeExpression)(a,b.trackingConfig)}},"ForInStatement|ForOfStatement":{enter:function enter(a){a.skipKey("left")},exit:function exit(a,b){var c=_core.types.stringLiteral((0,_utils.getLocString)(a.node.loc)),d=_core.types.stringLiteral(a.node.type),e=(0,_utils.findStackFrameIdIdentifier)(a);if(void 0===e){return}(0,_insert.wrapAndReplace)(a.get("right"),"loopIterable",b.trackingConfig,{force:!0,additionalParams:[c,d]});var f=a.node.right.loc;(0,_insert.insertLoopBodyBeginAndEnd)(a,f,b.trackingConfig);var g=(0,_utils.codeSeeCall)(_core.types,"loopEnd",[e,c]);if(b.trackingConfig.shouldTrack(_constants.codeSeeInlineTracking)){a.insertAfter(_core.types.expressionStatement(g))}}},"ForStatement|WhileStatement|DoWhileStatement":{exit:function exit(a,b){var c,d,e,f,g,h,i,j;if(a.node.test){(0,_insert.wrapAndReplace)(a.get("test"),"loopTest",b.trackingConfig,{force:!0})}var k=(0,_utils.findStackFrameIdIdentifier)(a);if(void 0===k){return}var l=[k,_core.types.stringLiteral((0,_utils.getLocString)(a.node.loc)),_core.types.stringLiteral(a.node.type)],m=(0,_utils.codeSeeCall)(_core.types,"loopStart",l),n=(0,_utils.codeSeeCall)(_core.types,"loopEnd",[l[0],l[1]]);if(b.trackingConfig.shouldTrack(_constants.codeSeeInlineTracking)){a.insertBefore(_core.types.expressionStatement(m));a.insertAfter(_core.types.expressionStatement(n))}var o={start:(null===(c=a.node.test)||void 0===c?void 0:null===(d=c.loc)||void 0===d?void 0:d.start)||(null===(e=a.node.update)||void 0===e?void 0:null===(f=e.loc)||void 0===f?void 0:f.start)||a.node.loc.start,end:(null===(g=a.node.update)||void 0===g?void 0:null===(h=g.loc)||void 0===h?void 0:h.end)||(null===(i=a.node.test)||void 0===i?void 0:null===(j=i.loc)||void 0===j?void 0:j.end)||a.node.loc.start};(0,_insert.insertLoopBodyBeginAndEnd)(a,o,b.trackingConfig)}},ContinueStatement:{exit:function exit(a,b){if(a.node.label){throw["CodeSee does not yet support `continue` statements with a label: "+JSON.stringify(a.node.loc)]}var c=(0,_utils.findStackFrameIdIdentifier)(a);if(c===void 0){return}var d=[c,_core.types.stringLiteral((0,_utils.getLocString)(a.node.loc))],e=(0,_utils.codeSeeCall)(_core.types,"loopBodyEnd",d);if(b.trackingConfig.shouldTrack(_constants.codeSeeInlineTracking)){a.insertBefore(_core.types.expressionStatement(e))}}},BreakStatement:{exit:function exit(a){if(a.node.label){throw["CodeSee does not yet support `break` statements with a label: "+JSON.stringify(a.node.loc)]}}},CatchClause:function CatchClause(a){a.skipKey("param")},MetaProperty:function MetaProperty(a){a.skip()},PrivateName:function PrivateName(a){a.skipKey("id")},UnaryExpression:{enter:function enter(a){if("typeof"===a.node.operator&&a.get("argument").isIdentifier()){a.skipKey("argument");return}if("delete"===a.node.operator){a.skipKey("argument")}}},FunctionExpression:{enter:function enter(a){a.skipKey("id")},exit:function exit(a,b){(0,_insert.wrapAndReplace)(a,"funcExp",b.trackingConfig)}},ArrowFunctionExpression:{exit:function exit(a,b){(0,_insert.wrapAndReplace)(a,"funcExp",b.trackingConfig)}}},c={IfStatement:{enter:function enter(a){var b={triviallyBoolean:!0};a.skipKey("consequent");a.skipKey("alternate");(0,_utils.traverseWithSkipKeys)(a,_triviallyBoolean["default"],b);a.skipKeys=[];if(b.triviallyBoolean){a.skipKey("test");a.node.test.triviallyBoolean=!0}},exit:function exit(a,b){if(a.node.test.triviallyBoolean){}else{(0,_insert.wrapAndReplace)(a.get("test"),"test",b.trackingConfig)}}},SwitchStatement:{exit:function exit(a,b){(0,_insert.wrapAndReplace)(a.get("discriminant"),"switchTest",b.trackingConfig)}},SwitchCase:{enter:function enter(a){a.skipKey("test")}},Expression:{enter:b.Expression.enter,exit:function exit(a,b){if(_core.types.isLiteral(a)||_core.types.isIdentifier(a)||_core.types.isCallExpression(a)||_core.types.isAssignmentExpression(a)||_core.types.isMemberExpression(a)||_core.types.isOptionalMemberExpression(a)||_core.types.isFunction(a)||_core.types.isThisExpression(a)||_core.types.isAwaitExpression(a)||_core.types.isParenthesizedExpression(a)||_core.types.isSuper(a)||_core.types.isMetaProperty(a)||_core.types.isYieldExpression(a)||"test"===a.key&&_core.types.isIfStatement(a.parentPath)||"discriminant"===a.key&&_core.types.isSwitchStatement(a.parentPath)||"callee"===a.key&&_core.types.isCallExpression(a.parentPath)||"right"===a.key&&(_core.types.isForInStatement(a.parentPath)||_core.types.isForOfStatement(a.parentPath))||_core.types.isReturnStatement(a.parentPath)||a.isConstantExpression()){return}var c={ids:0};a.traverse({Identifier:function Identifier(a,b){b.ids+=1}},c);if(0===c.ids){return}(0,_insert.wrapAndReplace)(a,"expr",b.trackingConfig)}},TaggedTemplateExpression:{enter:function enter(a){a.skipKey("tag")}},OptionalMemberExpression:{enter:function enter(a){a.skipKey("object");a.skipKey("property")},exit:function exit(a,b){(0,_insert.wrapAndReplace)(a,"read",b.trackingConfig)}},MemberExpression:{enter:function enter(a,b){if(!a.node.computed){a.skipKey("property")}if((0,_utils.isSacredMemberExpression)(a)){(0,_insert.wrapAndReplace)(a,"expr",b.trackingConfig);a.skip()}},exit:function exit(a,b){if("callee"===a.key)return;(0,_insert.wrapLikeIdentifier)(a,b,b.trackingConfig)}},UpdateExpression:{exit:function exit(a,b){var c=(a.node.prefix?"pre":"post")+("++"===a.node.operator?"Incr":"Decr");(0,_insert.wrapAndReplace)(a,c,b.trackingConfig)}},Identifier:{exit:function exit(a,b){if("key"===a.key)return;(0,_insert.wrapLikeIdentifier)(a,b,b.trackingConfig)}},ThisExpression:{exit:function exit(a,b){(0,_insert.wrapLikeIdentifier)(a,b,b.trackingConfig)}}};if(!a){return b}return _objectSpread(_objectSpread({},b),c)}