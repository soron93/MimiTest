"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.enumVisitor=exports.trackerVisitor=void 0;var _arrayPrototype=_interopRequireDefault(require("array.prototype.flatmap")),_core=require("@babel/core"),_insert=require("./data-tracking/insert"),_utils=require("../utils"),_constants=require("../constants"),_memberExpressions=_interopRequireDefault(require("./member-expressions"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);if(b)d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable});c.push.apply(c,d)}return c}function _objectSpread(a){for(var b=1,c;b<arguments.length;b++){c=null!=arguments[b]?arguments[b]:{};if(b%2){ownKeys(Object(c),!0).forEach(function(b){_defineProperty(a,b,c[b])})}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(a,Object.getOwnPropertyDescriptors(c))}else{ownKeys(Object(c)).forEach(function(b){Object.defineProperty(a,b,Object.getOwnPropertyDescriptor(c,b))})}}return a}function _defineProperty(a,b,c){if(b in a){Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0})}else{a[b]=c}return a}function _createForOfIteratorHelper(a,b){var c;if("undefined"==typeof Symbol||null==a[Symbol.iterator]){if(Array.isArray(a)||(c=_unsupportedIterableToArray(a))||b&&a&&"number"==typeof a.length){if(c)a=c;var d=0,e=function(){};return{s:e,n:function n(){if(d>=a.length)return{done:!0};return{done:!1,value:a[d++]}},e:function e(a){throw a},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var f=!0,g=!1,h;return{s:function s(){c=a[Symbol.iterator]()},n:function n(){var a=c.next();f=a.done;return a},e:function e(a){g=!0;h=a},f:function f(){try{if(!f&&null!=c["return"])c["return"]()}finally{if(g)throw h}}}}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(a);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}_arrayPrototype["default"].shim();var statementTypeIsSupported=function(a){return-1===["ClassDeclaration","BlockStatement","IfStatement","ImportDeclaration"].indexOf(a)},statementVisitor={Statement:function Statement(a,b){if(_core.types.isVariableDeclaration(a)||_core.types.isFunctionDeclaration(a)||_core.types.isForInStatement(a)||_core.types.isForOfStatement(a)||_core.types.isForStatement(a)||_core.types.isWhileStatement(a)||_core.types.isDoWhileStatement(a)){return}var c=(0,_utils.getDefaultState)(b,!1);if(b.trackingConfig.shouldTrack("filename")){c.filename=b.rootFileName}a.traverse(trackerVisitor,c);a.skip();if(statementTypeIsSupported(a.node.type)){(0,_insert.insertTracking)(_core.types,a,c,b.rootFileName,b.trackingConfig)}}},variableDeclarationVisitor={VariableDeclaration:function VariableDeclaration(a,b){if(a.node.declarations[0].id.codeseeId)return a.skip();if(a.node.declarations[0].id.name&&-1!==a.node.declarations[0].id.name.indexOf(_constants.codeSeeSource)){a.skip();return}var c=(0,_utils.getDefaultState)(b,!1),d=(0,_insert.trackersFromVariableDeclaration)(a);d.forEach(function(a){c.declares.push(a)});a.get("declarations").forEach(function(a){a.skipKey("id");(0,_utils.traverseWithSkipKeys)(a,trackerVisitor,c)});(0,_insert.insertTracking)(_core.types,a,c,b.rootFileName,b.trackingConfig);a.skip()}},functionDeclarationVisitor={FunctionDeclaration:{enter:function enter(a,b){a.skipKey("params");var c=(0,_utils.getDefaultState)(b,!1);(0,_utils.traverseWithSkipKeys)(a,trackerVisitor,c);a.skip()}}},callExpressionVisitor={CallExpression:{enter:function enter(a){var b=a.node.callee;if(_core.types.isIdentifier(b)){a.skipKey("callee")}}}},assignmentExpressionVisitor={AssignmentExpression:{enter:function enter(a,b){if((null===b||void 0===b?void 0:b.writes)===void 0){return}var c=a.node.left;if(_core.types.isPattern(c)||_core.types.isIdentifier(c)){var d=(0,_insert.trackersFromPatternOrIdentifier)(_core.types,a,c,_memberExpressions["default"]),e=_createForOfIteratorHelper(d),f;try{for(e.s();!(f=e.n()).done;){var g=f.value;b.writes.push(g)}}catch(a){e.e(a)}finally{e.f()}}else if(_core.types.isMemberExpression(c)){a.skipKey("right");var h=(0,_utils.getDefaultState)();(0,_utils.traverseWithSkipKeys)(a,_memberExpressions["default"],h);a.skipKeys=[];b.writes=[].concat(b.writes,h.accesses)}else{throw["CodeSee Error: AssignmentExpression: LHS is not Identifier, Pattern, or MemberExpression: "+a.node.type]}a.skipKey("left")}}},forLoopVisitor={"ForInStatement|ForOfStatement":function ForInStatementForOfStatement(a,b){a.skipKey("left");var c=a.get("left"),d;if(c.isVariableDeclaration()){d=(0,_insert.trackersFromVariableDeclaration)(c)}else{d=(0,_insert.trackersFromLHSPattern)(c.node)}(0,_insert.insertLoopVariableTracking)(_core.types,a,d,b.rootFileName,b.trackingConfig)},ForStatement:function ForStatement(a){a.skipKey("init")}},tryCatchVisitor={CatchClause:function CatchClause(a,b){var c=[];if(a.node.param){c=(0,_insert.trackersFromPatternOrIdentifier)(_core.types,a,a.node.param,_memberExpressions["default"])}(0,_insert.insertCatchParamTracking)(_core.types,a,c,b.rootFileName,b.trackingConfig)}},trackerVisitor=_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({},statementVisitor),variableDeclarationVisitor),functionDeclarationVisitor),callExpressionVisitor),assignmentExpressionVisitor),forLoopVisitor),tryCatchVisitor);exports.trackerVisitor=trackerVisitor;var enumVisitor={TSEnumDeclaration:function TSEnumDeclaration(a,b){var c=a.node.id,d=(0,_insert.trackersFromLHSPattern)(c);c.tracked=!0;c.loc=void 0;if(1!=d.length){return}var e=(0,_utils.getDefaultState)();d.forEach(function(a){e.declares.push(a)});(0,_insert.insertTracking)(_core.types,a,e,b.rootFileName,b.trackingConfig)}};exports.enumVisitor=enumVisitor;