"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.traceStackFrameVisitorFactory=exports.traceLineVisitor=exports.annotateFunctionNameVisitorFactory=void 0;var _utils=require("../utils"),_constants=require("../constants"),_core=require("@babel/core");function _defineProperty(a,b,c){if(b in a){Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0})}else{a[b]=c}return a}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_unsupportedIterableToArray(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(a);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function _iterableToArrayLimit(a,b){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(a)))return;var c=[],d=!0,e=!1,f=void 0;try{for(var g=a[Symbol.iterator](),h;!(d=(h=g.next()).done);d=!0){c.push(h.value);if(b&&c.length===b)break}}catch(a){e=!0;f=a}finally{try{if(!d&&null!=g["return"])g["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}var anonymousFunctionLabel="<anonymous function>",MARK="\u203A",insertLineTracing=function(a,b,c,d){if(c.shouldTrack(_constants.codeSeeLineTrace)&&b.node.loc){d=d||"root";var e=b.node.loc.start,f=b.node.loc.end;if(b.isIfStatement()){f=b.node.test.loc.end}else if(b.isTryStatement()){f=b.node.block.loc.start}else if(b.isSwitchStatement()){f=b.node.discriminant.loc.end}var g=(0,_utils.getLocString)({start:e,end:f}),h=(0,_utils.findStackFrameIdIdentifier)(b);if(h===void 0){return}var i=(0,_utils.codeSeeCall)(a,_constants.codeSeeLineTrace,[a.stringLiteral(d),(0,_utils.objToAST)(a,{loc:g,uid:h})]);b.insertBefore(a.expressionStatement(i))}},shouldTraceStatementType=function(a){return-1===["ClassDeclaration","BlockStatement","FunctionDeclaration"].indexOf(a)},traceLineVisitor={Statement:function Statement(a,b){if(shouldTraceStatementType(a.node.type)){insertLineTracing(_core.types,a,b.trackingConfig,b.rootFileName)}}};exports.traceLineVisitor=traceLineVisitor;var traceStackFrameVisitorFactory=function(a){var b={ReturnStatement:function ReturnStatement(a,b){var c=b.stackframeExitStatement;a.insertBefore(c)},YieldExpression:function YieldExpression(a,b){var c=b.stackframeExitStatement,d=b.stackFrameIdIdentifier,e=b.tracingArgAST,f=_core.types.expressionStatement(_core.types.assignmentExpression("=",d,(0,_utils.codeSeeCall)(_core.types,"backFromYield",[d,_core.types.stringLiteral((0,_utils.getLocString)(a.node.loc)),e])));if(a.parentPath.isExpressionStatement()){a.parentPath.insertBefore(c);a.parentPath.insertAfter(f)}else if(!0!==a.node.wrappedForStackFrameTracing){a.node.wrappedForStackFrameTracing=!0;var g=(0,_utils.liftAndReplace)(_core.types,a,"yieldValue");g.insertBefore(c);g.insertAfter(f)}},CatchClause:function CatchClause(a,b){var c=b.stackFrameIdIdentifier,d={start:a.node.loc.start,end:a.node.body.loc.start},e=_core.types.expressionStatement(_core.types.assignmentExpression("=",c,(0,_utils.codeSeeCall)(_core.types,_constants.codeSeeStackframeCaught,[c,_core.types.stringLiteral((0,_utils.getLines)(d).loc)])));(0,_utils.insertAsFirstStatementOfBlock)(a.get("body"),e)},Function:function Function(a){a.skip()}},c=function(a,c,d,e){var f=c.node.loc;if(f===void 0){return}if(c.isClassMethod({kind:"constructor"})){var p=c.find(function(a){return a.isClass()});f=p.node.loc}var g=f!==void 0?(0,_utils.getLocString)(f):"",h=c.node.functionName||anonymousFunctionLabel,i=(0,_utils.objToAST)(a,{functionName:h,filename:d,loc:g}),j=(0,_utils.getStackFrameIdIdentifier)(c);if(j===void 0){return}var k=a.isProgram(c)?c.get("body"):c.get("body").get("body"),l=k[0],m=k[k.length-1],n=a.variableDeclaration("let",[a.variableDeclarator(j,(0,_utils.codeSeeCall)(a,_constants.codeSeeStackframe,[i]))]),o=a.expressionStatement((0,_utils.codeSeeCall)(a,_constants.codeSeeStackframeExit,[j]));if(!e.shouldTrack(_constants.codeSeeStackframe)){return}if(l){l.insertBefore(n);if(!a.isReturnStatement(m)){m.insertAfter(o)}c.traverse(b,{stackframeEnterStatement:n,stackframeExitStatement:o,stackFrameIdIdentifier:j,tracingArgAST:i})}else{c.node.body.body=[n,o]}},d=["FunctionDeclaration","FunctionExpression","ArrowFunctionExpression","ClassMethod","ObjectMethod","Program"],e=a.split(/[\.-]/),f=_slicedToArray(e,5),g=f[0],h=f[1],i=f[2],j=f[3],k=f[4];if(7<g||7==g&&2<=h){d.push("ClassPrivateMethod")}var l=_defineProperty({},d.join("|"),function(a,b){c(_core.types,a,b.rootFileName,b.trackingConfig)});return l};exports.traceStackFrameVisitorFactory=traceStackFrameVisitorFactory;var annotateFunctionName=function(a,b){a.node.functionName=b},findVarNameBeingAssignedTo=function(a){var b=a.parentPath.node;if(_core.types.isVariableDeclarator(b)&&_core.types.isIdentifier(b.id)){return b.id.name}else if(_core.types.isAssignmentExpression(b)){if(_core.types.isIdentifier(b.left)){return b.left.name}else if(_core.types.isMemberExpression(b.left)){var c=stringFromMemberAndCallExpressions(b.left);if(c){return c}}}return null};function stringFromMemberAndCallExpressions(a){var b=[],c=0;while(!0){if(_core.types.isMemberExpression(a)){if(!0!==a.computed&&_core.types.isIdentifier(a.property)){var d=a.property.name+"()".repeat(c);c=0;b.push(d);a=a.object}else{break}}else if(_core.types.isCallExpression(a)){c++;a=a.callee}else if(_core.types.isIdentifier(a)){var e=a.name+"()".repeat(c);c=0;b.push(e);break}else{break}}if(0===b.length){return!1}else{return b.reverse().join(".")}}function constructClassAndFunctionName(a,b){if(_core.types.isClassBody(a.parentPath)&&_core.types.isClassDeclaration(a.parentPath.parentPath)&&_core.types.isIdentifier(a.parentPath.parentPath.node.id)){return a.parentPath.parentPath.node.id.name+"."+b}return b}var annotateFunctionNameVisitorFactory=function(a){var b={FunctionDeclaration:function FunctionDeclaration(a){var b=anonymousFunctionLabel;if(_core.types.isIdentifier(a.node.id)){b=a.node.id.name}else if(_core.types.isExportDefaultDeclaration(a.parentPath)){b="export default function"}annotateFunctionName(a,b)},"FunctionExpression|ArrowFunctionExpression":function FunctionExpressionArrowFunctionExpression(a){var b=anonymousFunctionLabel,c=a.parentPath,d=findVarNameBeingAssignedTo(a);if(d){b=d}else if(_core.types.isObjectProperty(c)&&_core.types.isIdentifier(c.node.key)){b=c.node.key.name;var e=findVarNameBeingAssignedTo(c.parentPath);if(e){b=e+"."+b}}else if(_core.types.isClassProperty(c)&&_core.types.isIdentifier(c.node.key)){b=constructClassAndFunctionName(c,c.node.key.name)}else if("arguments"===a.listKey&&(c.isCallExpression()||c.isNewExpression())){var f=a.parentPath.get("callee");if(f.isIdentifier()){b="".concat(f.node.name," callback")}else if(f.isMemberExpression()||f.isCallExpression()){var g=stringFromMemberAndCallExpressions(f.node);if(g){b="".concat(g," callback")}else{b="<anonymous callback>"}}else{b="<anonymous callback>"}var h=findVarNameBeingAssignedTo(a.parentPath);if(h){b="".concat(h," ").concat(MARK," ").concat(b)}}annotateFunctionName(a,b)},ClassMethod:function ClassMethod(a){var b=anonymousFunctionLabel;if(_core.types.isIdentifier(a.node.id)){b=a.node.id.name}else if(_core.types.isIdentifier(a.node.key)){b=a.node.key.name}b=constructClassAndFunctionName(a,b);annotateFunctionName(a,b)},ObjectMethod:function ObjectMethod(a){var b=anonymousFunctionLabel,c=!1;if(_core.types.isIdentifier(a.node.key)){b=a.node.key.name}else if(_core.types.isStringLiteral(a.node.key)){b=a.node.key.value}else if(_core.types.isMemberExpression(a.node.key)&&_core.types.isIdentifier(a.node.key.object)&&_core.types.isIdentifier(a.node.key.property)&&"Symbol"===a.node.key.object.name){b="[Symbol."+a.node.key.property.name+"]";c=!0}var d=findVarNameBeingAssignedTo(a.parentPath);if(d){if(c){b=d+b}else{b=d+"."+b}}annotateFunctionName(a,b)},Program:function Program(a,b){annotateFunctionName(a,b.rootFileName)}},c=a.split(/[\.-]/),d=_slicedToArray(c,5),e=d[0],f=d[1],g=d[2],h=d[3],i=d[4];if(7<e||7==e&&2<=f){b.ClassPrivateMethod=function(a){var b=anonymousFunctionLabel;if(_core.types.isPrivateName(a.node.key)&&_core.types.isIdentifier(a.node.key.id)){b=a.node.key.id.name}else if(_core.types.isIdentifier(a.node.key)){b=a.node.key.name}b=constructClassAndFunctionName(a,b);annotateFunctionName(a,b)}}return b};exports.annotateFunctionNameVisitorFactory=annotateFunctionNameVisitorFactory;