"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.insertCatchParamTracking=insertCatchParamTracking;exports.insertFunctionParamTracking=insertFunctionParamTracking;exports.insertLoopVariableTracking=insertLoopVariableTracking;exports.insertTracking=insertTracking;exports.trackersFromPatternOrIdentifier=trackersFromPatternOrIdentifier;exports.trackersFromVariableDeclaration=trackersFromVariableDeclaration;exports.trackersFromLHSPattern=trackersFromLHSPattern;var _constants=require("../../constants"),_utils=require("../../utils"),_uid=require("../../uid"),_patterns=require("../../patterns"),_traverse=_interopRequireDefault(require("@babel/traverse"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _typeof(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}function makeTrackerArgument(a,b,c,d){var e=[];["declares","writes","accesses"].filter(function(a){return d.shouldTrack(a)}).map(function(f){var g=b[f];if(g.length){var h=objectValuesFromTrackers(a,g,c,d,function(a){return"declares"===f&&"value"===a});e.push(a.objectProperty(a.identifier(f),a.arrayExpression(h)))}});return a.objectExpression(e)}function objectValuesFromTrackers(a,b,c,d,e){var f=b.map(function(b){if(d.shouldTrack("filename"))b.filename=c;return a.objectExpression(Object.keys(b).filter(function(a){if(!d.shouldTrack(a)||e&&e(a)){return!1}return!0}).sort().map(function(c){var e=b[c],f;if("value"===c){if("this"===e){f=a.thisExpression()}else{f=a.identifier(e)}}else if("name"===c){if("object"!==_typeof(e)){f=a.stringLiteral(e)}else{f=a.arrayExpression(e)}}else if("object"===_typeof(e)){f=a.objectExpression(Object.keys(e).filter(function(a){return d.shouldTrack(a)}).map(function(b){var c="number"==typeof e[b]?a.numericLiteral(e[b]):a.stringLiteral(e[b]);return a.objectProperty(a.stringLiteral(b),c)}))}else{f="number"==typeof e?a.numericLiteral(e):a.stringLiteral(e)}var g=a.objectProperty(a.identifier(c),f);return g}))});return f}function insertTracking(a,b,c,d,e){var f=makeTrackerArgument(a,c,d,e);insertBeforeTracker(a,b,f,e);c.writes=[].concat(c.writes,c.declares);c.declares=[];var g=makeTrackerArgument(a,c,d,e);insertAfterTracker(a,b,g,e)}function insertBeforeTracker(a,b,c,d){if(c.properties.length&&d.shouldTrack(_constants.codeSeeBefore)){var e=(0,_utils.findStackFrameIdIdentifier)(b);if(e===void 0){return}var f=(0,_utils.codeSeeCall)(a,_constants.codeSeeBefore,[c,e]);b.insertBefore(a.expressionStatement(f))}}function insertAfterTracker(a,b,c,d){if(c.properties.length&&d.shouldTrack(_constants.codeSeeAfter)){var e=(0,_utils.findStackFrameIdIdentifier)(b);if(e===void 0){return}var f=(0,_utils.codeSeeCall)(a,_constants.codeSeeAfter,[c,e]);b.insertAfter(a.expressionStatement(f))}}function insertFunctionParamTracking(a,b,c,d,e,f){var g=objectValuesFromTrackers(a,c,d,e);if(!f){var k=a.objectExpression([a.objectProperty(a.identifier("name"),a.stringLiteral("this")),a.objectProperty(a.identifier("value"),a.identifier("this"))]);g.unshift(k)}var h=(0,_utils.getStackFrameIdIdentifier)(b);if(h===void 0){return}var i=(0,_utils.codeSeeCall)(a,_constants.codeSeeFuncParams,[a.arrayExpression(g),h]),j=a.expressionStatement(i);if(e.shouldTrack(_constants.codeSeeFuncParams)){(0,_utils.insertAsFirstStatementOfBlock)(b.get("body"),j)}}function insertCatchParamTracking(a,b,c,d,e){var f=objectValuesFromTrackers(a,c,d,e),g=b.get("body").get("body"),h=(0,_utils.findStackFrameIdIdentifier)(b);if(h===void 0){return}var i={start:b.node.loc.start,end:b.node.body.loc.start},j=(0,_utils.codeSeeCall)(a,_constants.codeSeeCatchParam,[a.arrayExpression(f),h,a.stringLiteral((0,_utils.getLocString)(i)),a.stringLiteral(d)]),k=a.expressionStatement(j),l=g[0];if(e.shouldTrack(_constants.codeSeeCatchParam)){if(l){if(a.isVariableDeclaration(l)&&a.isCallExpression(l.declarations[0].init)&&l.declarations[0].init.callee.name===_constants.codeSeeStackframeCaught){l.insertAfter(k)}else{l.insertBefore(k)}}else{b.node.body.body=[k]}}}function insertLoopVariableTracking(a,b,c,d,e){var f=objectValuesFromTrackers(a,c,d,e),g=(0,_utils.findStackFrameIdIdentifier)(b);if(g===void 0){return}var h=(0,_utils.codeSeeCall)(a,_constants.codeSeeLoopVars,[a.arrayExpression(f),g]),i=a.expressionStatement(h),j=b.get("body").get("body"),k=j[0];if(e.shouldTrack(_constants.codeSeeLoopVars)){if(k){k.insertBefore(i)}else{b.node.body.body=[i]}}}function trackersFromPatternOrIdentifier(a,b,c,d){var e=(0,_patterns.leftNodesFromPattern)(c).flatMap(function(c){if(c.tracked){return[]}if(a.isIdentifier(c)){if(!c.loc){return[]}var e=c.name,f=(0,_uid.determineIdentifierUID)(e,b);return{name:e,uid:f,value:e,loc:(0,_utils.getLocString)(c.loc)}}else if(a.isMemberExpression(c)){var g=(0,_utils.getDefaultState)();(0,_traverse["default"])(a.expressionStatement(c),d,b.scope,g,b);return g.accesses}else{throw["trackersFromPatternOrIdentifier(): Unexpected node type in pattern: "+c.type]}});return e}function trackersFromVariableDeclaration(a){return a.node.declarations.flatMap(function(a){return trackersFromLHSPattern(a.id)})}function trackersFromLHSPattern(a){var b=(0,_patterns.leftNodesFromPattern)(a);return b.filter(function(a){return a.loc&&!a.tracked}).map(function(a){var b=(0,_uid.generateIdentifierUID)(a);return{name:a.name,uid:b,value:a.name,loc:(0,_utils.getLocString)(a.loc)}})}